import{b as u,U as ie,j as e,q as m,C as le,G as A,p as n,w as C,z as L,E as O,F as ce,V as R,x as f,W as de,X as y,I as H,y as ue,Y as me,A as pe}from"./index-6iWKD2A3.js";import{V,R as G,a as P,C as W,P as K,E as xe,b as he,H as be,L as je,I as ge,c as fe,d as ve}from"./VpnKey-D0tIhT1d.js";import{F as S}from"./FormControlLabel-BRSDlIiK.js";import{I as v}from"./InputAdornment-CyCcCxfs.js";import{S as X}from"./Stack-CVGlZwtP.js";import{P as Y}from"./Person-B4ybhAZ1.js";const b=i=>i.nom_article?decodeURIComponent(i.nom_article):i.nom?decodeURIComponent(i.nom):"Article Sans Nom",Ne=()=>{const{cartItems:i}=u.useContext(ie),[d,J]=u.useState({}),[l,Q]=u.useState({clientType:"particulier",name:"",email:"",phone:"",address:"",postalCode:"",additionalInfo:""}),[p,E]=u.useState({}),[x,w]=u.useState({}),[Z,I]=u.useState(!1),[ee,M]=u.useState(""),[re,T]=u.useState("success");u.useEffect(()=>{i.forEach(s=>{const r=b(s);r&&!d[r]&&fetch(`https://cl-back.onrender.com/produit/cles/by-name?nom=${encodeURIComponent(r)}`).then(t=>{if(!t.ok)throw new Error(`Erreur lors de la récupération des détails pour ${r}`);return t.json()}).then(t=>{console.log(`Données récupérées pour ${r} :`,t),J(o=>({...o,[r]:t}))}).catch(t=>{console.error(`Erreur pour ${r} :`,t)})})},[i,d]),u.useEffect(()=>{i.forEach((s,r)=>{const t=b(s),o=d[t]||{};(o.prixSansCartePropriete?Number(o.prixSansCartePropriete):0)===0&&!p[r]&&E(a=>({...a,[r]:"numero"}))})},[d,i,p]);const j=s=>{const{name:r,value:t}=s.target;Q(o=>({...o,[r]:t}))},te=(s,r)=>{E(t=>({...t,[s]:r}))},_=(s,r,t)=>{w(o=>({...o,[s]:{...o[s]||{},[r]:t}}))},q=(s,r,t)=>{t&&t[0]&&w(o=>({...o,[s]:{...o[s]||{},[r]:t[0]}}))},D=(s,r)=>{const t=b(s),o=d[t]||{};return(s.cle_avec_carte_propriete||o.cleAvecCartePropriete)&&(p[r]||"numero")==="postal"?Number(o.prixSansCartePropriete)||0:Number(o.prix)||0},oe={lettre:3,chronopost:5,recommande:10},se=(s,r)=>{var o;if((p[r]||"numero")==="postal"){const c=(o=x[r])==null?void 0:o.shippingMethod;return oe[c]||0}return 0},k=()=>i.reduce((s,r,t)=>s+D(r,t),0),N=()=>i.reduce((s,r,t)=>s+se(r,t),0),F=()=>k()+N(),ne=()=>{var r;if([l.name,l.email,l.phone,l.address,l.postalCode].some(t=>!t.trim()))return!1;for(let t=0;t<i.length;t++){const o=i[t];if(o.cle_avec_carte_propriete||(r=d[b(o)])!=null&&r.cleAvecCartePropriete){const c=p[t]||"numero",a=x[t]||{};if(c==="numero"&&(!a.keyNumber||!a.frontPhoto||!a.backPhoto)||c==="postal"&&(!a.frontPhoto||!a.backPhoto||!a.shippingMethod))return!1}}return!0},ae=()=>{if(!ne()){M("Veuillez remplir tous les champs obligatoires."),T("error"),I(!0);return}const s={userInfo:l,articles:i.map((r,t)=>{var c;const o=b(r);if(r.cle_avec_carte_propriete||(c=d[o])!=null&&c.cleAvecCartePropriete){const a=p[t]||"numero",g=x[t]||{};return{nom:o,mode:a,prix:a==="numero"?Number((d[o]||{}).prix)||0:Number((d[o]||{}).prixSansCartePropriete)||0,keyNumber:a==="numero"&&g.keyNumber||"",shippingMethod:a==="postal"&&g.shippingMethod||"",frontPhoto:g.frontPhoto||null,backPhoto:g.backPhoto||null}}else return{nom:o,prix:Number((d[o]||{}).prix)||0}}),subtotal:k(),shippingFees:N(),totalPrice:F()};console.log("Payload de la commande :",s),M(`Commande validée pour ${F()} € !`),T("success"),I(!0)},U=(s,r)=>{r!=="clickaway"&&I(!1)};return e.jsxs(m,{sx:{backgroundColor:"#F2F2F2",minHeight:"100vh",py:4},children:[e.jsx(le,{maxWidth:"lg",sx:{mt:{xs:4,md:12},px:{xs:2,md:0}},children:e.jsxs(A,{container:!0,spacing:4,children:[e.jsx(A,{item:!0,xs:12,md:8,children:e.jsxs(m,{sx:{backgroundColor:"#fff",p:{xs:2,md:3},borderRadius:1,boxShadow:1},children:[e.jsx(n,{variant:"h5",gutterBottom:!0,children:"Informations de Commande"}),e.jsx(C,{sx:{mb:2}}),i.map((s,r)=>{var g,$,z,B;const t=b(s),o=d[t]||{},c=o.prix?Number(o.prix):0,a=o.prixSansCartePropriete?Number(o.prixSansCartePropriete):0;return e.jsxs(L,{sx:{mb:4},children:[s.image&&e.jsx(O,{component:"img",image:s.image,alt:t,sx:{objectFit:"cover",height:{xs:150,md:200}}}),e.jsxs(ce,{children:[e.jsx(n,{variant:"h5",gutterBottom:!0,children:t}),s.cle_avec_carte_propriete||o.cleAvecCartePropriete?e.jsxs(e.Fragment,{children:[e.jsxs(n,{variant:"body1",color:"textSecondary",children:["Prix avec carte : ",c," €"]}),a>0&&e.jsxs(n,{variant:"body1",color:"textSecondary",sx:{mb:1},children:["Prix sans carte (envoi postal) : ",a," €"]}),e.jsx(C,{sx:{my:1}}),e.jsxs(n,{variant:"h6",sx:{mt:2,mb:1,color:"#025920"},children:[e.jsx(V,{sx:{verticalAlign:"middle",mr:1}}),"Informations pour la clé *"]}),a>0?e.jsx(R,{component:"fieldset",sx:{mb:2},children:e.jsxs(G,{row:!0,value:p[r]||"numero",onChange:h=>te(r,h.target.value),children:[e.jsx(S,{value:"numero",control:e.jsx(P,{}),label:`Par numéro (${c} €)`}),e.jsx(S,{value:"postal",control:e.jsx(P,{}),label:`Par envoi postal (${a} €)`})]})}):null,(p[r]==="numero"||a===0)&&e.jsx(f,{placeholder:"* Numéro inscrit sur la clé",variant:"outlined",fullWidth:!0,value:((g=x[r])==null?void 0:g.keyNumber)||"",onChange:h=>_(r,"keyNumber",h.target.value),sx:{mb:2,borderRadius:2},InputProps:{startAdornment:e.jsx(v,{position:"start",children:e.jsx(V,{color:"action"})})},required:!0}),p[r]==="postal"&&e.jsxs(e.Fragment,{children:[e.jsx(n,{variant:"subtitle1",sx:{fontWeight:"bold",mb:1},children:"Type de Livraison"}),e.jsx(R,{fullWidth:!0,sx:{mb:2},children:e.jsxs(de,{value:(($=x[r])==null?void 0:$.shippingMethod)||"",onChange:h=>_(r,"shippingMethod",h.target.value),displayEmpty:!0,inputProps:{"aria-label":"Type de Livraison"},required:!0,children:[e.jsx(y,{value:"",disabled:!0,children:"Sélectionnez un type de livraison"}),e.jsx(y,{value:"lettre",children:e.jsxs(m,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(W,{sx:{mr:1}}),"Lettre (3€ - 3 jours)"]})}),e.jsx(y,{value:"chronopost",children:e.jsxs(m,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(W,{sx:{mr:1}}),"Chronopost Sécurisé (5€ - 1 jour)"]})}),e.jsx(y,{value:"recommande",children:e.jsxs(m,{sx:{display:"flex",alignItems:"center"},children:[e.jsx(W,{sx:{mr:1}}),"Recommandé Sécurisé (10€ - 2 jours)"]})})]})})]}),e.jsxs(X,{direction:"row",spacing:2,alignItems:"center",sx:{mb:2},children:[e.jsx(n,{variant:"body2",sx:{minWidth:"130px"},children:"Photo (recto) * :"}),e.jsxs(H,{color:"primary","aria-label":"Télécharger la photo recto",component:"label",sx:{backgroundColor:"#E3F2FD",borderRadius:"8px",p:1},children:[e.jsx("input",{type:"file",accept:"image/*",hidden:!0,onChange:h=>q(r,"frontPhoto",h.target.files)}),e.jsx(K,{})]}),((z=x[r])==null?void 0:z.frontPhoto)&&e.jsx(n,{variant:"caption",color:"success.main",children:x[r].frontPhoto.name})]}),e.jsxs(X,{direction:"row",spacing:2,alignItems:"center",sx:{mb:2},children:[e.jsx(n,{variant:"body2",sx:{minWidth:"130px"},children:"Photo (verso) * :"}),e.jsxs(H,{color:"primary","aria-label":"Télécharger la photo verso",component:"label",sx:{backgroundColor:"#E3F2FD",borderRadius:"8px",p:1},children:[e.jsx("input",{type:"file",accept:"image/*",hidden:!0,onChange:h=>q(r,"backPhoto",h.target.files)}),e.jsx(K,{})]}),((B=x[r])==null?void 0:B.backPhoto)&&e.jsx(n,{variant:"caption",color:"success.main",children:x[r].backPhoto.name})]})]}):e.jsxs(n,{variant:"body1",color:"textSecondary",children:["Prix : ",Number(o.prix)||0," €"]})]})]},r)}),e.jsxs(n,{variant:"h5",sx:{mt:2,mb:2,color:"#025920"},children:[e.jsx(Y,{sx:{verticalAlign:"middle",mr:1}}),"Informations Client *"]}),e.jsx(R,{component:"fieldset",sx:{mb:2},children:e.jsxs(G,{row:!0,name:"clientType",value:l.clientType,onChange:j,children:[e.jsx(S,{value:"particulier",control:e.jsx(P,{}),label:"Particulier"}),e.jsx(S,{value:"entreprise",control:e.jsx(P,{}),label:"Entreprise"})]})}),e.jsx(f,{placeholder:l.clientType==="entreprise"?"* Nom de l'entreprise":"* Nom et prénom",variant:"outlined",fullWidth:!0,name:"name",value:l.name,onChange:j,sx:{mb:3,borderRadius:2},InputProps:{startAdornment:e.jsx(v,{position:"start",children:e.jsx(Y,{color:"action"})})},required:!0}),e.jsx(f,{placeholder:"* Adresse email",variant:"outlined",fullWidth:!0,name:"email",type:"email",value:l.email,onChange:j,sx:{mb:3,borderRadius:2},InputProps:{startAdornment:e.jsx(v,{position:"start",children:e.jsx(xe,{color:"action"})})},required:!0}),e.jsx(f,{placeholder:"* Téléphone",variant:"outlined",fullWidth:!0,name:"phone",type:"tel",value:l.phone,onChange:j,sx:{mb:3,borderRadius:2},InputProps:{startAdornment:e.jsx(v,{position:"start",children:e.jsx(he,{color:"action"})})},required:!0}),e.jsx(f,{placeholder:"* Adresse de livraison",variant:"outlined",fullWidth:!0,name:"address",value:l.address,onChange:j,sx:{mb:3,borderRadius:2},InputProps:{startAdornment:e.jsx(v,{position:"start",children:e.jsx(be,{color:"action"})})},required:!0}),e.jsx(f,{placeholder:"* Code postal",variant:"outlined",fullWidth:!0,name:"postalCode",value:l.postalCode,onChange:j,sx:{mb:3,borderRadius:2},InputProps:{startAdornment:e.jsx(v,{position:"start",children:e.jsx(je,{color:"action"})})},required:!0}),e.jsx(f,{placeholder:"Informations complémentaires de livraison (optionnel)",variant:"outlined",fullWidth:!0,name:"additionalInfo",value:l.additionalInfo,onChange:j,sx:{mb:3,borderRadius:2},InputProps:{startAdornment:e.jsx(v,{position:"start",children:e.jsx(ge,{color:"action"})})}})]})}),e.jsx(A,{item:!0,xs:12,md:4,children:e.jsxs(L,{sx:{p:{xs:2,md:3},borderRadius:1,boxShadow:1},children:[e.jsx(n,{variant:"h6",sx:{mb:2},children:"Résumé de la commande"}),i.map((s,r)=>e.jsxs(m,{sx:{display:"flex",mb:2},children:[s.image&&e.jsx(O,{component:"img",image:s.image,alt:b(s),sx:{width:80,height:{xs:60,md:80},objectFit:"cover",mr:2,borderRadius:1}}),e.jsxs(m,{children:[e.jsx(n,{variant:"subtitle1",children:b(s)}),e.jsxs(n,{variant:"body2",color:"text.secondary",children:[D(s,r)," €"]})]})]},r)),e.jsx(C,{sx:{my:1}}),e.jsxs(m,{sx:{display:"flex",justifyContent:"space-between",my:1},children:[e.jsx(n,{variant:"subtitle1",sx:{fontWeight:"bold"},children:"Sous-total"}),e.jsxs(n,{variant:"subtitle1",sx:{fontWeight:"bold"},children:[k()," €"]})]}),e.jsxs(m,{sx:{display:"flex",justifyContent:"space-between",my:1},children:[e.jsx(n,{variant:"subtitle1",sx:{fontWeight:"bold"},children:"Frais de livraison"}),e.jsxs(n,{variant:"subtitle1",sx:{fontWeight:"bold"},children:[N()," €"]})]}),e.jsx(C,{sx:{my:1}}),e.jsxs(m,{sx:{display:"flex",justifyContent:"space-between",my:1},children:[e.jsx(n,{variant:"subtitle1",sx:{fontWeight:"bold"},children:"Total"}),e.jsxs(n,{variant:"subtitle1",sx:{fontWeight:"bold"},children:[F()," €"]})]}),e.jsx(ue,{variant:"contained",fullWidth:!0,onClick:ae,sx:{mt:2,backgroundColor:"#1B5E20",color:"#fff","&:hover":{backgroundColor:"#16641C"}},children:"Commander"})]})})]})}),e.jsx(me,{open:Z,autoHideDuration:6e3,onClose:U,anchorOrigin:{vertical:"bottom",horizontal:"center"},children:e.jsx(pe,{onClose:U,severity:re,sx:{width:"100%",display:"flex",alignItems:"center"},iconMapping:{success:e.jsx(fe,{fontSize:"inherit"}),error:e.jsx(ve,{fontSize:"inherit"})},children:ee})})]})};export{Ne as default};
