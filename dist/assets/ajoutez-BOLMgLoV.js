import{b as m,j as e,C as V,p as u,q as D,G as l,x as b,y as S,A as K,z as Q,E as J,F as _,H as X}from"./index-6iWKD2A3.js";import{F as M}from"./FormControlLabel-BRSDlIiK.js";import{C as k}from"./Checkbox-DLZzfESe.js";import{C as Y}from"./CardActions-CEyLDF7y.js";import"./Stack-CVGlZwtP.js";const o="#2E7D32",f="#1B5E20",Z="#A5D6A7",U="https://cl-back.onrender.com";function H(t,h){const[y,j]=m.useState(t);return m.useEffect(()=>{const v=setTimeout(()=>j(t),h);return()=>clearTimeout(v)},[t,h]),y}const ee=(t,h=800,y=800,j=.7)=>new Promise((v,N)=>{const E=new FileReader;E.readAsDataURL(t),E.onload=p=>{const g=new Image;g.src=p.target.result,g.onload=()=>{let{width:x,height:C}=g;(x>h||C>y)&&(x>C?(C=Math.round(C*h/x),x=h):(x=Math.round(x*y/C),C=y));const P=document.createElement("canvas");P.width=x,P.height=C,P.getContext("2d").drawImage(g,0,0,x,C),P.toBlob(w=>{const R=new FileReader;R.readAsDataURL(w),R.onloadend=()=>{v(R.result)}},t.type,j)},g.onerror=x=>N(x)},E.onerror=p=>N(p)}),ie=()=>{const[t,h]=m.useState({cleAvecCartePropriete:!1,prix:"",prixSansCartePropriete:"",nom:"",marque:"",imageDataUrl:"",referenceEbauche:"",typeReproduction:"copie",descriptionProduit:"",descriptionNumero:"",estCleAPasse:!1,prixCleAPasse:"",besoinPhoto:!1,besoinNumeroCle:!1,besoinNumeroCarte:!1}),[y,j]=m.useState([]),[v,N]=m.useState(!1),[E,p]=m.useState(null),[g,x]=m.useState(""),C=H(g,300),[P,I]=m.useState(null),[w,R]=m.useState(10),[A,q]=m.useState(null),d=m.useCallback(r=>{const{name:s,value:n,type:c,checked:i}=r.target;h(a=>({...a,[s]:c==="checkbox"?i:n}))},[]),$=r=>{x(r.target.value)},W=m.useCallback(async r=>{const s=r.target.files[0];if(s)try{let n;s.size>1024*1024?n=await ee(s):n=await new Promise((c,i)=>{const a=new FileReader;a.onload=()=>c(a.result),a.onerror=()=>i(new Error("Erreur de lecture de fichier")),a.readAsDataURL(s)}),h(c=>({...c,imageDataUrl:n}))}catch(n){console.error("Erreur lors de la compression de l'image:",n),p("Erreur lors de la compression de l'image")}},[]),F=r=>{q(r),h({cleAvecCartePropriete:r.cleAvecCartePropriete,prix:r.prix.toString(),prixSansCartePropriete:r.prixSansCartePropriete?r.prixSansCartePropriete.toString():"",nom:r.nom,marque:r.marque,imageDataUrl:r.imageUrl,referenceEbauche:r.referenceEbauche||"",typeReproduction:r.typeReproduction,descriptionProduit:r.descriptionProduit||"",descriptionNumero:r.descriptionNumero||"",estCleAPasse:r.estCleAPasse,prixCleAPasse:r.prixCleAPasse?r.prixCleAPasse.toString():"",besoinPhoto:r.besoinPhoto||!1,besoinNumeroCle:r.besoinNumeroCle||!1,besoinNumeroCarte:r.besoinNumeroCarte||!1})},O=()=>{h({cleAvecCartePropriete:!1,prix:"",prixSansCartePropriete:"",nom:"",marque:"",imageDataUrl:"",referenceEbauche:"",typeReproduction:"copie",descriptionProduit:"",descriptionNumero:"",estCleAPasse:!1,prixCleAPasse:"",besoinPhoto:!1,besoinNumeroCle:!1,besoinNumeroCarte:!1}),q(null)},L=async r=>{if(r.preventDefault(),p(null),!t.nom||!t.marque||t.prix===""||!t.imageDataUrl){p("Veuillez remplir tous les champs obligatoires et sélectionner une image.");return}const s={nom:t.nom,marque:t.marque,prix:Number(t.prix),cleAvecCartePropriete:t.cleAvecCartePropriete,...t.prixSansCartePropriete!==""&&{prixSansCartePropriete:Number(t.prixSansCartePropriete)},imageUrl:t.imageDataUrl,referenceEbauche:t.referenceEbauche.trim()!==""?t.referenceEbauche:null,typeReproduction:t.typeReproduction,descriptionProduit:t.descriptionProduit,descriptionNumero:t.descriptionNumero,estCleAPasse:t.estCleAPasse,...t.estCleAPasse&&t.prixCleAPasse!==""&&{prixCleAPasse:Number(t.prixCleAPasse)},besoinPhoto:t.besoinPhoto,besoinNumeroCle:t.besoinNumeroCle,besoinNumeroCarte:t.besoinNumeroCarte};try{N(!0);let n;if(A){if(n=await fetch(`${U}/produit/cles/update?nom=${encodeURIComponent(A.nom)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}),!n.ok){const i=await n.json(),a=i.message||i.error||`Erreur ${n.status}: Une erreur est survenue lors de la modification.`;p(a);return}const c=await n.json();j(i=>i.map(a=>a.nom===A.nom?c:a))}else{if(n=await fetch(`${U}/produit/cles/add`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}),!n.ok){const i=await n.json(),a=i.message||i.error||`Erreur ${n.status}: Une erreur est survenue lors de l'ajout.`;p(a);return}const c=await n.json();j(i=>{if(!i.some(a=>a.id===c.id)){const a=[...i,c];return a.sort((G,z)=>z.id-G.id),a}return i}),I(i=>i!==null?i+1:i)}O()}catch(n){p(`Erreur : ${n.message}`)}finally{N(!1)}};m.useEffect(()=>{(async()=>{try{const s=await fetch(`${U}/produit/cles/count`);if(s.ok){const n=await s.json();I(n.count)}else console.error("Erreur lors de la récupération du nombre de clés :",s.status)}catch(s){console.error("Erreur dans fetchCount :",s)}})()},[]),m.useEffect(()=>{if(P!==null)for(let r=0;r<P;r++)fetch(`${U}/produit/cles/index/${r}`).then(s=>s.ok?s.json():null).then(s=>{s&&j(n=>{if(!n.some(c=>c.id===s.id)){const c=[...n,s];return c.sort((i,a)=>a.id-i.id),c}return n})}).catch(s=>console.error(`Erreur dans fetchKeyByIndex pour index ${r} :`,s))},[P]);const T=y.filter(r=>r.nom.toLowerCase().includes(C.toLowerCase())),B=T.slice(0,w);return e.jsxs(V,{maxWidth:!1,disableGutters:!0,sx:{py:{xs:2,sm:4},px:{xs:1,sm:3}},children:[e.jsx(u,{variant:"h4",align:"center",gutterBottom:!0,sx:{color:o},children:A?"Modifier l'article":"Ajouter un article"}),e.jsx(D,{component:"form",onSubmit:L,noValidate:!0,sx:{mb:4,p:{xs:2,sm:3},border:`1px solid ${Z}`,borderRadius:2,backgroundColor:"#f1f8e9"},children:e.jsxs(l,{container:!0,spacing:2,children:[e.jsx(l,{item:!0,xs:12,sm:6,children:e.jsx(b,{label:"Nom",name:"nom",value:t.nom,onChange:d,required:!0,fullWidth:!0,variant:"outlined",sx:{"& .MuiOutlinedInput-root":{borderColor:o}}})}),e.jsx(l,{item:!0,xs:12,sm:6,children:e.jsx(b,{label:"Marque",name:"marque",value:t.marque,onChange:d,required:!0,fullWidth:!0,variant:"outlined",sx:{"& .MuiOutlinedInput-root":{borderColor:o}}})}),e.jsx(l,{item:!0,xs:12,children:e.jsx(b,{label:"Référence Ébauche",name:"referenceEbauche",value:t.referenceEbauche,onChange:d,fullWidth:!0,variant:"outlined",sx:{"& .MuiOutlinedInput-root":{borderColor:o}}})}),e.jsx(l,{item:!0,xs:12,children:e.jsx(b,{label:"Description du produit",name:"descriptionProduit",value:t.descriptionProduit,onChange:d,fullWidth:!0,multiline:!0,rows:3,variant:"outlined",sx:{"& .MuiOutlinedInput-root":{borderColor:o}}})}),e.jsx(l,{item:!0,xs:12,sm:6,children:e.jsx(b,{label:"Prix (€)",name:"prix",type:"number",value:t.prix,onChange:d,required:!0,fullWidth:!0,inputProps:{min:0},variant:"outlined",sx:{"& .MuiOutlinedInput-root":{borderColor:o}}})}),e.jsx(l,{item:!0,xs:12,sm:6,children:e.jsx(b,{label:"Prix Sans Carte Propriété (€)",name:"prixSansCartePropriete",type:"number",value:t.prixSansCartePropriete,onChange:d,fullWidth:!0,inputProps:{min:0},variant:"outlined",sx:{"& .MuiOutlinedInput-root":{borderColor:o}}})}),e.jsx(l,{item:!0,xs:12,sm:6,sx:{display:"flex",alignItems:"center"},children:e.jsx(M,{control:e.jsx(k,{name:"cleAvecCartePropriete",checked:t.cleAvecCartePropriete,onChange:d,sx:{color:o,"&.Mui-checked":{color:o}}}),label:"Clé avec carte de propriété"})}),e.jsx(l,{item:!0,xs:12,sm:6,children:e.jsxs(b,{select:!0,label:"Type de reproduction",name:"typeReproduction",value:t.typeReproduction,onChange:d,required:!0,fullWidth:!0,variant:"outlined",SelectProps:{native:!0},sx:{"& .MuiOutlinedInput-root":{borderColor:o}},children:[e.jsx("option",{value:"copie",children:"Copie"}),e.jsx("option",{value:"numero",children:"Numéro"}),e.jsx("option",{value:"ia",children:"IA"})]})}),t.typeReproduction==="numero"&&e.jsx(l,{item:!0,xs:12,children:e.jsx(b,{label:"Description du numéro",name:"descriptionNumero",value:t.descriptionNumero,onChange:d,fullWidth:!0,variant:"outlined",sx:{"& .MuiOutlinedInput-root":{borderColor:o}}})}),e.jsx(l,{item:!0,xs:12,sm:6,sx:{display:"flex",alignItems:"center"},children:e.jsx(M,{control:e.jsx(k,{name:"estCleAPasse",checked:t.estCleAPasse,onChange:d,sx:{color:o,"&.Mui-checked":{color:o}}}),label:"Clé à passe"})}),t.estCleAPasse&&e.jsx(l,{item:!0,xs:12,sm:6,children:e.jsx(b,{label:"Prix clé à passe (€)",name:"prixCleAPasse",type:"number",value:t.prixCleAPasse,onChange:d,fullWidth:!0,inputProps:{min:0},variant:"outlined",sx:{"& .MuiOutlinedInput-root":{borderColor:o}}})}),e.jsxs(l,{item:!0,xs:12,children:[e.jsx(u,{variant:"subtitle1",sx:{color:o,mb:1},children:"Exigences du produit :"}),e.jsx(M,{control:e.jsx(k,{name:"besoinPhoto",checked:t.besoinPhoto,onChange:d,sx:{color:o,"&.Mui-checked":{color:o}}}),label:"Exiger des photos"}),e.jsx(M,{control:e.jsx(k,{name:"besoinNumeroCle",checked:t.besoinNumeroCle,onChange:d,sx:{color:o,"&.Mui-checked":{color:o}}}),label:"Exiger un numéro de clé"}),e.jsx(M,{control:e.jsx(k,{name:"besoinNumeroCarte",checked:t.besoinNumeroCarte,onChange:d,sx:{color:o,"&.Mui-checked":{color:o}}}),label:"Exiger un numéro de carte"})]}),e.jsxs(l,{item:!0,xs:12,children:[e.jsxs(S,{variant:"contained",component:"label",sx:{bgcolor:o,"&:hover":{bgcolor:f}},children:["Télécharger une image",e.jsx("input",{type:"file",accept:"image/*",hidden:!0,onChange:W})]}),t.imageDataUrl&&e.jsxs(D,{sx:{mt:2},children:[e.jsx(u,{variant:"caption",sx:{color:o},children:"Aperçu de l'image :"}),e.jsx(D,{component:"img",src:t.imageDataUrl,alt:"Aperçu",sx:{width:{xs:"100%",sm:120},height:"auto",mt:1,borderRadius:1,boxShadow:1}})]})]}),E&&e.jsx(l,{item:!0,xs:12,children:e.jsx(K,{severity:"error",sx:{borderColor:o,color:o},children:E})}),e.jsx(l,{item:!0,xs:12,children:e.jsx(S,{type:"submit",variant:"contained",fullWidth:!0,disabled:v,sx:{bgcolor:o,"&:hover":{bgcolor:f}},children:v?A?"Modification en cours...":"Ajout en cours...":A?"Modifier":"Ajouter"})}),A&&e.jsx(l,{item:!0,xs:12,children:e.jsx(S,{variant:"outlined",fullWidth:!0,onClick:O,sx:{borderColor:o,color:o,"&:hover":{borderColor:f,color:f},mt:1},children:"Annuler"})})]})}),e.jsx(u,{variant:"h5",gutterBottom:!0,sx:{color:o},children:"Liste des Produits"}),e.jsx(D,{sx:{mb:3,mt:2},children:e.jsx(b,{label:"Rechercher une clé",value:g,onChange:$,fullWidth:!0,variant:"outlined",sx:{"& .MuiOutlinedInput-root":{borderColor:o}}})}),e.jsx(l,{container:!0,spacing:2,children:B.map(r=>e.jsx(l,{item:!0,xs:12,sm:6,md:4,children:e.jsxs(Q,{sx:{borderRadius:2,boxShadow:3},children:[r.imageUrl&&e.jsx(J,{component:"img",image:r.imageUrl,alt:r.nom,sx:{height:180,objectFit:"cover"}}),e.jsxs(_,{children:[e.jsxs(u,{variant:"h6",gutterBottom:!0,sx:{color:o},children:[r.nom," (ID: ",r.id,")"]}),e.jsxs(u,{variant:"body2",color:"text.secondary",children:["Marque : ",r.marque]}),e.jsxs(u,{variant:"body2",color:"text.secondary",children:["Prix : ",r.prix," €"]}),r.prixSansCartePropriete>0&&e.jsxs(u,{variant:"body2",color:"text.secondary",children:["Prix sans carte propriété : ",r.prixSansCartePropriete," €"]}),e.jsxs(u,{variant:"body2",color:"text.secondary",children:["Clé avec carte propriété : ",r.cleAvecCartePropriete?"Oui":"Non"]}),r.referenceEbauche&&e.jsxs(u,{variant:"body2",color:"text.secondary",children:["Référence ébauche : ",r.referenceEbauche]}),e.jsxs(u,{variant:"body2",color:"text.secondary",children:["Type de reproduction : ",r.typeReproduction]}),r.typeReproduction==="numero"&&r.descriptionNumero&&e.jsxs(u,{variant:"body2",color:"text.secondary",children:["Description numéro : ",r.descriptionNumero]}),r.descriptionProduit&&e.jsxs(u,{variant:"body2",color:"text.secondary",children:["Description produit : ",r.descriptionProduit]}),e.jsxs(u,{variant:"body2",color:"text.secondary",children:["Clé à passe : ",r.estCleAPasse?"Oui":"Non"]}),r.estCleAPasse&&r.prixCleAPasse&&e.jsxs(u,{variant:"body2",color:"text.secondary",children:["Prix clé à passe : ",r.prixCleAPasse," €"]})]}),e.jsxs(Y,{children:[e.jsx(S,{onClick:()=>F(r),variant:"outlined",sx:{borderColor:o,color:o,"&:hover":{borderColor:f,color:f}},children:"Modifier"}),e.jsx(S,{onClick:()=>{window.confirm(`Voulez-vous vraiment supprimer la clé "${r.nom}" ?`)&&fetch(`${U}/produit/cles/delete?nom=${encodeURIComponent(r.nom)}`,{method:"DELETE"}).then(s=>{s.ok?j(n=>n.filter(c=>c.nom!==r.nom)):console.error("Erreur lors de la suppression, status:",s.status)}).catch(s=>console.error("Erreur lors de la suppression :",s))},variant:"outlined",sx:{borderColor:o,color:o,"&:hover":{borderColor:f,color:f}},children:"Supprimer"})]})]})},r.id))}),w<T.length&&e.jsx(D,{sx:{mt:2,display:"flex",justifyContent:"center"},children:e.jsx(S,{variant:"contained",onClick:()=>R(w+10),sx:{bgcolor:o,"&:hover":{bgcolor:f}},children:"Afficher 10 produits suivants"})}),v&&e.jsx(X,{sx:{mt:2}})]})};export{ie as default};
